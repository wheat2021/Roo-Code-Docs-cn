---
sidebar_label: '智能上下文压缩'
---
import Codicon from '@site/src/components/Codicon';

# 智能上下文压缩

智能上下文压缩功能通过总结对话的早期部分来帮助管理长对话。这可以防止在上下文窗口接近其限制时丢失重要信息。此功能**默认启用**。

<div style={{ position: 'relative', paddingBottom: '56.25%', height: 0, overflow: 'hidden' }}>
  <iframe
    src="https://www.youtube.com/embed/9k8OAXlszak"
    style={{
      position: 'absolute',
      top: 0,
      left: 0,
      width: '100%',
      height: '100%',
    }}
    frameBorder="0"
    allow="autoplay; encrypted-media"
    allowFullScreen
  ></iframe>
</div>

<br />
---

## 工作原理

随着您与 Roo Code 的对话越来越长，可能会接近底层 AI 模型的上下文窗口限制。当这种情况发生时，通常会删除较早的消息以腾出空间。智能上下文压缩旨在通过以下方式防止这种突然的丢失：

1.  **总结：** 使用 AI 模型，它会压缩对话的早期部分。
2.  **保留要点：** 目标是减少总令牌数，同时保留被总结消息中的关键信息。
3.  **保持流畅性：** 这使得 AI 能够对整个对话（即使是非常长的对话）有更连贯的理解。

**重要注意事项：**
*   **总结的影响：** 虽然如果您使用[检查点](/features/checkpoints)来回溯，原始消息会被保留，但在正在进行的 LLM 调用中会使用总结版本，以保持上下文的可管理性。
*   **成本：** 执行总结的 AI 调用会产生费用。此成本包含在 UI 中显示的上下文压缩指标中。

---

## 配置

智能上下文压缩**默认启用**并提供多个配置选项：

1.  打开 Roo Code 设置（Roo Code 面板右上角的 <Codicon name="gear" /> 图标）。
2.  导航到“上下文”设置部分。
3.  配置可用选项：
    - **自动触发智能上下文压缩**：默认启用，此选项控制是否自动进行压缩。
    - **触发智能上下文压缩的阈值**：一个百分比滑块（默认为 100%），根据上下文窗口的使用情况确定何时激活压缩。
    - **用于上下文压缩的 API 配置**：选择用于压缩操作的 API 配置（默认为您当前活动的配置）。
    - **自定义上下文压缩提示**：自定义用于上下文压缩操作的系统提示。

<img src="/img/intelligent-context-condensing/intelligent-context-condensing.png" alt="智能上下文压缩设置" width="600" />
*智能上下文压缩配置选项：自动触发开关、阈值滑块、API 配置选择和自定义提示定制。*
---

## 控制和理解上下文压缩

Roo Code 提供了多种方式来控制和理解智能上下文压缩功能：

### 控制上下文压缩
*   **自动阈值：** “上下文”设置中的阈值滑块允许您定义一个上下文窗口使用百分比（例如 80%）。当对话达到此容量水平时，Roo Code 将尝试自动压缩上下文。
*   **API 配置：** 选择用于上下文压缩操作的 API 配置。如果需要，这允许您为压缩专门使用不同的提供商或模型。
*   **自定义提示：** 修改用于压缩的系统提示，以更好地适应您的工作流程或强调对话总结的某些方面。
*   **手动触发：** 在任务顶部的上下文栏右侧有一个**压缩上下文**按钮。这允许您随时启动上下文压缩过程。

    <img src="/img/intelligent-context-condensing/intelligent-context-condensing-1.png" alt="展开任务视图中的手动压缩上下文按钮" width="600" />
    *手动压缩上下文按钮（用黄色箭头突出显示）易于访问，可进行手动控制。*

### 理解上下文压缩活动
*   **上下文压缩指标：** 当发生上下文压缩时，Roo Code 会显示：
    *   上下文压缩前后的上下文令牌计数。
    *   与上下文压缩 AI 调用相关的成本。
    *   一个可展开的摘要，详细说明了压缩的内容（此信息是聊天记录中可见的 `ContextCondenseRow` 组件的一部分）。

<img src="/img/intelligent-context-condensing/intelligent-context-condensing-2.png" alt="聊天中上下文压缩的消息" width="600" />
*上下文压缩后，一条消息指示上下文已被压缩，显示令牌变化和成本。*

*   **视觉指示器：**
    *   当上下文压缩处于活动状态时，聊天界面中会显示一个进度指示器（“正在压缩上下文...”）。

<img src="/img/intelligent-context-condensation/intelligent-context-condensation-3.png" alt="聊天中正在压缩上下文的进度指示器" width="600" />
*“正在压缩上下文...”指示器在处理过程中出现在聊天中。*

    *   任务标题还会显示当前的上下文压缩状态。
    *   `ContextWindowProgress` 栏提供了令牌分布的可视化表示，包括当前使用情况、为 AI 输出保留的空间、可用空间和原始令牌数。
*   **界面清晰度：** “压缩上下文”按钮包含一个工具提示，解释其功能，并支持所有支持的语言。

---

## 技术实现

### 令牌计数
Roo Code 使用一个复杂的令牌计数系统，该系统：
- 在可用时使用本机令牌计数端点（例如，Anthropic 的 API）
- 如果 API 调用失败，则回退到 tiktoken 估算
- 为不同内容类型提供准确的计数：
  - 文本内容：使用基于单词的估算，并考虑标点符号和换行符的开销
  - 图像内容：每张图像保守估计为 300 个令牌
  - 系统提示：包括结构元素的额外开销

### 上下文窗口管理
- 默认情况下，保留 30% 的上下文窗口（20% 用于模型输出，10% 作为安全缓冲），为对话历史记录留出 70% 的可用空间。
- 此保留可以被特定于模型的设置覆盖
- 系统在维持此保留的同时自动计算可用空间
