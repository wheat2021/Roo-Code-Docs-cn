# codebase_search

:::warning 实验性功能
`codebase_search` 工具是实验性功能 [代码库索引](/features/experimental/codebase-indexing) 的一部分。该功能正处于积极开发阶段，未来版本可能会有重大变更。它需要额外的设置，包括嵌入服务提供商和向量数据库。
:::

`codebase_search` 工具使用 AI 嵌入在您的整个代码库中执行语义搜索。与传统的基于文本的搜索不同，它能理解您查询的含义，并找到相关代码，即使关键字不完全匹配。

---

## 参数

该工具接受以下参数：

- `query` (必需): 描述您要查找内容自然语言搜索查询。
- `path` (可选): 用于将搜索范围限制在代码库特定部分的目录路径。

---

## 功能

此工具使用语义相似性而非精确文本匹配来搜索您已索引的代码库。它能找到与您的查询在概念上相关的代码块，即使它们不包含您搜索的确切词语。结果包括相关代码片段、文件路径、行号和相似度分数。

---

## 使用时机

- 当 Roo 需要在您的项目中查找与特定功能相关的代码时。
- 当寻找实现模式或类似代码结构时。
- 当搜索错误处理、身份验证或其他概念性代码模式时。
- 当探索不熟悉的代码库以了解功能实现方式时。
- 当查找可能受更改或重构影响的相关代码时。

---

## 主要特性

- **语义理解**: 通过含义而非精确关键字匹配来查找代码。
- **跨项目搜索**: 在整个索引的代码库中搜索，而不仅仅是打开的文件。
- **上下文结果**: 返回带有文件路径和行号的代码片段，便于导航。
- **相似度评分**: 结果按相关性排序，并附有相似度分数（0-1范围）。
- **范围过滤**: 可选的 `path` 参数可将搜索限制在特定目录。
- **智能排名**: 结果按与查询的语义相关性排序。
- **UI 集成**: 结果以语法高亮和导航链接显示。
- **性能优化**: 基于向量的快速搜索，具有可配置的结果限制。

---

## 要求

此工具仅在正确配置实验性代码库索引功能后可用：

- **功能已启用**: 必须在实验性设置中启用代码库索引。
- **嵌入服务提供商**: 需要 OpenAI API 密钥或 Ollama 配置。
- **向量数据库**: Qdrant 实例正在运行且可访问。
- **索引状态**: 代码库必须已索引（状态：“已索引”或“索引中”）。

---

## 限制

- **实验性功能**: 是实验性代码库索引系统的一部分。
- **需要配置**: 依赖于外部服务（嵌入服务提供商 + Qdrant）。
- **索引依赖**: 仅搜索已索引的代码块。
- **结果限制**: 为保持性能，每次搜索最多返回 50 个结果。
- **相似度阈值**: 仅返回相似度分数高于 0.4 的结果。
- **文件大小限制**: 仅限于已成功索引的 1MB 以下的文件。
- **语言支持**: 有效性取决于 Tree-sitter 的语言支持。

---

## 工作原理

调用 `codebase_search` 工具时，它会遵循以下流程：

1.  **可用性验证**:
    -   验证 CodeIndexManager 是否可用并已初始化。
    -   确认在设置中已启用代码库索引。
    -   检查索引配置是否正确（API 密钥、Qdrant URL）。
    -   验证当前索引状态是否允许搜索。

2.  **查询处理**:
    -   接收您的自然语言查询并生成一个嵌入向量。
    -   使用为索引配置的相同嵌入服务提供商（OpenAI 或 Ollama）。
    -   将查询的语义含义转换为数学表示。

3.  **向量搜索执行**:
    -   在 Qdrant 向量数据库中搜索相似的代码嵌入。
    -   使用余弦相似度查找最相关的代码块。
    -   应用最小相似度阈值（0.4）来过滤结果。
    -   将结果限制为 50 个匹配项以获得最佳性能。

4.  **路径过滤** (如果指定):
    -   过滤结果，仅包含指定目录路径下的文件。
    -   使用规范化路径比较进行准确过滤。
    -   在过滤后的范围内保持相关性排名。

5.  **结果处理和格式化**:
    -   将绝对文件路径转换为工作区相对路径。
    -   将结果结构化，包含文件路径、行范围、相似度分数和代码内容。
    -   为 AI 使用和 UI 显示进行格式化，并提供语法高亮。

6.  **双重输出格式**:
    -   **AI 输出**: 结构化文本格式，包含查询、文件路径、分数和代码块。
    -   **UI 输出**: JSON 格式，具有语法高亮和导航功能。

---

## 搜索查询最佳实践

### 有效的查询模式

**良好：概念性且具体**
```xml
<codebase_search>
<query>用户认证和密码验证</query>
</codebase_search>
```

**良好：以功能为中心**
```xml
<codebase_search>
<query>数据库连接池设置</query>
</codebase_search>
```

**良好：以问题为导向**
```xml
<codebase_search>
<query>API 请求的错误处理</query>
</codebase_search>
```

**效果较差：过于宽泛**
```xml
<codebase_search>
<query>函数</query>
</codebase_search>
```

### 效果良好的查询类型

- **功能描述**: "文件上传处理", "邮件验证逻辑"
- **技术模式**: "单例模式实现", "工厂方法使用"
- **领域概念**: "用户资料管理", "支付处理工作流"
- **架构组件**: "中间件配置", "数据库迁移脚本"

---

## 目录范围限定

使用可选的 `path` 参数将搜索集中在代码库的特定部分：

**在 API 模块内搜索：**
```xml
<codebase_search>
<query>端点验证中间件</query>
<path>src/api</path>
</codebase_search>
```

**在测试文件中搜索：**
```xml
<codebase_search>
<query>模拟数据设置模式</query>
<path>tests</path>
</codebase_search>
```

**搜索特定功能目录：**
```xml
<codebase_search>
<query>组件状态管理</query>
<path>src/components/auth</path>
</codebase_search>
```

---

## 结果解读

### 相似度分数

- **0.8-1.0**: 高度相关的匹配，很可能正是您要找的。
- **0.6-0.8**: 良好的匹配，具有很强的概念相似性。
- **0.4-0.6**: 可能相关，但可能需要审查。
- **低于 0.4**: 因差异太大而被过滤掉。

### 结果结构

每个搜索结果包括：
- **文件路径**: 到包含匹配项文件的工作区相对路径。
- **分数**: 表示相关性的相似度分数（0.4-1.0）。
- **行范围**: 代码块的起始和结束行号。
- **代码块**: 与您的查询匹配的实际代码内容。

---

## 使用示例

- 在实现新功能时，Roo 搜索“身份验证中间件”以在编写新代码前了解现有模式。
- 在调试问题时，Roo 搜索“API 调用中的错误处理”以在整个代码库中查找相关的错误模式。
- 在重构代码时，Roo 搜索“数据库事务模式”以确保所有数据库操作的一致性。
- 在熟悉新代码库时，Roo 搜索“配置加载”以了解应用程序的启动方式。

---

## 用法示例

在整个项目中搜索与身份验证相关的代码：
```xml
<codebase_search>
<query>用户登录和身份验证逻辑</query>
</codebase_search>
```

在特定目录中查找与数据库相关的代码：
```xml
<codebase_search>
<query>数据库连接和查询执行</query>
<path>src/data</path>
</codebase_search>
```

在 API 代码中寻找错误处理模式：
```xml
<codebase_search>
<query>HTTP 错误响应和异常处理</query>
<path>src/api</path>
</codebase_search>
```

搜索测试工具和模拟设置：
```xml
<codebase_search>
<query>测试设置和模拟数据创建</query>
<path>tests</path>
</codebase_search>
```

查找配置和环境设置代码：
```xml
<codebase_search>
<query>环境变量和应用程序配置</query>
</codebase_search>