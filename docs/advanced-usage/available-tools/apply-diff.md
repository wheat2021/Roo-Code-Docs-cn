# apply_diff

`apply_diff` 工具通过精确指定要替换的内容，对文件进行精准、外科手术式的更改。它使用一种复杂的策略来查找和应用更改，同时保持正确的代码格式和结构。

---

## 参数

该工具接受以下参数：

- `path` (必需): 要修改的文件的路径，相对于当前工作目录。
- `diff` (必需): 定义更改的搜索/替换块，使用特定于当前差异策略的格式。
- `start_line` (可选): 一个提示，指示搜索内容开始的位置。_注意：当前主要策略似乎未使用此顶级参数，而是依赖于差异内容中的 `:start_line:`。_
- `end_line` (可选): 一个提示，指示搜索内容结束的位置。_注意：当前主要策略似乎未使用此顶级参数。_

---

## 功能说明

此工具使用由行号提示引导的模糊匹配，对现有文件应用有针对性的更改，以精确定位和替换内容。与简单的搜索和替换不同，它根据提供的内容和位置提示来识别要替换的确切块。

---

## 使用场景

- 当 Roo 需要对现有代码进行精确更改而无需重写整个文件时。
- 在重构代码的特定部分，同时保持周围上下文时。
- 以手术般的精度修复现有代码中的错误时。
- 在实现仅修改文件某些部分的功能增强时。

---

## 主要特性

- 使用由 `:start_line:` 提示引导的模糊匹配（基于规范化字符串的莱文斯坦距离），具有可配置的置信度阈值（通常为 0.8-1.0）。
- 使用 `BUFFER_LINES`（默认为 40）提供匹配项周围的上下文。
- 在提示的起始行周围的可配置上下文窗口（`bufferLines`）内执行由中间向外展开的搜索。
- 通过替换确切的块来被动地保留代码格式和缩进。
- 在差异视图中显示更改，供用户在应用前审查和编辑。
- 跟踪每个文件的连续错误（`consecutiveMistakeCountForApplyDiff`），以防止重复失败。
- 根据 `.rooignore` 规则验证文件访问权限。
- 有效处理多行编辑。

---

## 局限性

- 对于独特、有特色的代码段效果最佳，以便可靠识别。
- 对于非常大的文件或高度重复的代码模式，性能可能会有所不同。
- 如果内容模棱两可，模糊匹配偶尔可能会选择不正确的位置。
- 每种差异策略都有特定的格式要求。
- 复杂的编辑可能需要仔细选择策略或手动审查。

---

## 工作原理

当调用 `apply_diff` 工具时，它会遵循以下流程：

1.  **参数验证**: 验证必需的 `path` 和 `diff` 参数。
2.  **RooIgnore 检查**: 验证目标文件路径是否被 `.rooignore` 规则所允许。
3.  **文件分析**: 加载目标文件内容。
4.  **查找匹配项**: 在上下文窗口（`BUFFER_LINES`）内，使用由 `:start_line:` 提示引导的模糊匹配算法（基于规范化字符串的莱文斯坦距离），从中间向外搜索，根据置信度阈值定位目标内容。
5.  **准备更改**: 通过替换已识别的块来生成建议的更改。
6.  **用户交互**:
    *   在差异视图中显示更改。
    *   允许用户审查并可能编辑建议的更改。
    *   等待用户批准或拒绝。
7.  **应用更改**: 如果获得批准，则将更改（可能包括用户编辑）应用于文件。
8.  **错误处理**: 如果发生错误（例如，匹配失败、部分应用），则增加该文件的 `consecutiveMistakeCountForApplyDiff` 并报告失败类型。
9.  **反馈**: 返回结果，包括任何用户反馈或错误详情。

---

## Diff 格式要求

`<diff>` 参数需要一种特定格式，支持在单个请求中进行一次或多次更改。每个更改块都需要为原始内容提供行号提示。

*   **要求**: `SEARCH` 块内容的精确匹配（在模糊阈值内），包括空格和缩进。每个块内都必须有 `:start_line:` 行号提示。`:end_line:` 提示是可选的（但解析器支持）。文件中 `<<<<<<<` 之类的标记必须在 SEARCH 块中进行转义 (`\\`)。

`<diff>` 块的示例格式：

```diff
<<<<<<< SEARCH
:start_line:10
:end_line:12
-------
    // 旧的计算逻辑
    const result = value * 0.9;
    return result;
=======
    // 更新了计算逻辑并添加了日志记录
    console.log(`正在为值计算: ${value}`);
    const result = value * 0.95; // 调整了因子
    return result;
>>>>>>> REPLACE

<<<<<<< SEARCH
:start_line:25
:end_line:25
-------
    const defaultTimeout = 5000;
=======
    const defaultTimeout = 10000; // 增加了超时时间
>>>>>>> REPLACE
```

---

## 实验性功能：多文件编辑 (`MULTI_FILE_APPLY_DIFF`)

`apply_diff` 的一个实验性版本允许在单个工具调用中对多个文件应用更改。此功能通过 `MULTI_FILE_APPLY_DIFF` 实验标志激活。

### 实验模式的主要特性

- **多文件操作**: 在一个请求中编辑多个文件，简化复杂的重构任务。
- **批量批准界面**: 当目标为多个文件时，会弹出一个统一的界面，供用户一次性批准或拒绝所有更改，或单独管理每个文件的权限。
- **新的 XML 格式**: 引入了一种新的、更结构化的 XML 格式，使用 `<args>` 和 `<file>` 标签来处理多个操作。
- **向后兼容**: 实验性工具仍然与旧的单文件 `path` 和 `diff` 参数格式兼容。

### 工作原理 (实验性)

1.  **实验检查**: 工具首先检查 `MULTI_FILE_APPLY_DIFF` 实验是否已启用。如果未启用，则回退到旧的 `apply_diff` 实现。
2.  **参数解析**: 它解析新的 `<args>` XML 格式，以识别所有目标文件及其对应的差异操作。它也可以处理旧的 `path`/`diff` 参数。
3.  **验证和批准**:
    *   它验证所有目标文件都存在且可访问（未被 `.rooignore` 阻止）。
    *   如果正在修改多个文件，它会向用户显示一个**批量批准**对话框。
4.  **应用差异**: 对于每个已批准的文件，它使用 `MultiFileSearchReplaceDiffStrategy` 应用指定的差异。此策略可以对单个文件应用多个不重叠的更改。
5.  **结果**: 它返回一个综合的结果消息，总结所有尝试操作的结果。

### 新的 Diff 格式 (实验性)

实验模式在 `<apply_diff>` 工具调用中使用了一种新的 XML 结构。

- **`<args>`**: 所有文件操作的容器。
- **`<file>`**: 每个要修改的文件的块。包含 `<path>` 和一个或多个 `<diff>` 标签。
- **`<path>`**: 文件的相对路径。
- **`<diff>`**: 包含更改的块。
    - **`<content>`**: `SEARCH/REPLACE` 块。
    - **`<start_line>`**: (可选) 行号提示。

**示例：在一次调用中修改两个文件**

```xml
<apply_diff>
  <args>
    <file>
      <path>src/services/auth.service.ts</path>
      <diff>
        <content>
<<<<<<< SEARCH
:start_line:50
-------
    const token_expiration = '15m';
=======
    const token_expiration = '30m';
>>>>>>> REPLACE
        </content>
      </diff>
    </file>
    <file>
      <path>src/config/auth.config.ts</path>
      <diff>
        <content>
<<<<<<< SEARCH
:start_line:12
-------
    rateLimit: 5,
=======
    rateLimit: 10,
>>>>>>> REPLACE
        </content>
      </diff>
    </file>
  </args>
</apply_diff>
