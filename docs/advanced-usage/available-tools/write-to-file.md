# write_to_file

`write_to_file` 工具通过一个交互式审批流程来创建新文件或完全替换现有文件内容。它提供一个差异视图，用于在应用更改前进行审查。

---

## 参数

该工具接受以下参数：

- `path` (必需): 要写入的文件的路径，相对于当前工作目录。
- `content` (必需): 要写入文件的完整内容。
- `line_count` (必需): 文件中的行数，包括空行。

---

## 功能说明

此工具将内容写入指定文件，如果文件不存在则创建新文件，如果文件已存在则完全覆盖。所有更改都需要通过差异视图界面进行明确的用户批准，用户可以在应用更改前审查甚至编辑提议的更改。

---

## 使用场景

- 当 Roo 需要从头开始创建新文件时
- 当 Roo 需要完全重写现有文件时
- 为新项目创建多个文件时
- 生成配置文件、文档或源代码时
- 当您需要在应用更改前审查它们时

---

## 主要特性

- 交互式批准：在差异视图中显示更改，需要明确批准才能应用。
- 支持用户编辑：允许在最终批准前编辑提议的内容。
- 安全措施：检测代码遗漏、验证路径并防止内容截断。
- 编辑器集成：打开一个差异视图，并自动滚动到第一个差异处。
- 内容预处理：处理来自不同 AI 模型的产物，以确保内容干净。
- 访问控制：在进行更改前根据 `.rooignore` 的限制进行验证。
- 父目录：可能通过系统依赖项处理目录创建。
- 完全替换：在单次操作中提供一个完全转换后的文件。

---

## 限制

- 不适用于现有文件：修改现有文件时，比 `apply_diff` 慢得多，效率也低得多。
- 处理大文件时的性能：文件越大，操作速度会明显变慢。
- 完全覆盖：替换整个文件内容，无法保留原始内容。
- 需要行数：需要准确的行数来检测潜在的内容截断。
- 审查开销：与直接编辑相比，审批过程增加了额外的步骤。
- 仅限交互式：不能用于需要非交互式执行的自动化工作流。

---

## 工作原理

当调用 `write_to_file` 工具时，它会遵循以下流程：

1.  **参数验证**：验证必需的参数和权限。
    -   检查是否提供了 `path`、`content` 和 `line_count`。
    -   如果 `line_count` 缺失/无效，在修改现有文件时，会撤销任何差异视图的更改并返回一个错误，建议使用替代工具（如 `apply_diff`、`insert_content` 等）。
    -   验证文件是否被允许（未被 `.rooignore` 限制）。
    -   确保路径在工作区边界内。
    -   跟踪缺失参数的连续错误次数。
    -   为每个验证失败显示具体的错误消息。

2.  **内容预处理**：
    -   移除 AI 模型可能添加的代码块标记。
    -   处理转义的 HTML 实体（特别针对非 Claude 模型）。
    -   如果内容中意外包含了行号，则将其剥离。
    -   为不同的 AI 提供商执行特定于模型的处理。

3.  **生成差异视图**：
    -   在编辑器中打开一个差异视图，显示提议的更改。
    -   增加 300 毫秒的延迟以确保 UI 响应性。
    -   自动滚动到第一个差异处。
    -   高亮显示更改以便于审查。

4.  **用户审批流程**：
    -   等待用户明确批准才能继续。
    -   允许用户在差异视图中编辑内容。
    -   捕获任何用户编辑以用于最终内容。
    -   提供完全拒绝更改的选项。
    -   检测并整合用户的修改到最终结果中。

5.  **安全验证**：
    -   通过与提供的行数进行比较，检测潜在的内容截断。
    -   如果内容看起来不完整，则显示警告。
    -   验证文件路径和访问权限。
    -   使用 `isOutsideWorkspace` 标志专门检查文件是否在工作区之外。

6.  **文件写入**：
    -   将批准的内容（包括任何用户编辑）写入文件。
    -   提供写入成功的确认信息。
    -   成功后重置连续错误计数器。

---

## 使用示例

-   创建新项目时，Roo 会生成多个文件，但允许您在提交更改前审查每一个文件。
-   设置配置文件时，Roo 会在差异视图中显示提议的配置以供批准。
-   生成文档时，Roo 会创建 Markdown 文件，但允许您在差异视图中进行最终调整。
-   开发原型时，Roo 会在差异视图中显示完整的源文件，您可以在保存前进行微调。

---

## 用法示例

创建一个新的 JSON 配置文件：
```
<write_to_file>
<path>config/settings.json</path>
<content>
{
  "apiEndpoint": "https://api.example.com",
  "theme": {
    "primaryColor": "#007bff",
    "secondaryColor": "#6c757d",
    "fontFamily": "Arial, sans-serif"
  },
  "features": {
    "darkMode": true,
    "notifications": true,
    "analytics": false
  },
  "version": "1.0.0"
}
